/* packaged at 2013-09-07 */
"use strict";angular.module("myApp",["ngSanitize","myApp.filters","myApp.services","myApp.directives","myApp.controllers","HashManager","ngCookies"]).run(["HashManager","ModManager","User","$cookieStore",function(a,b,c,d){if(d.get("userinfo")){var e=d.get("userinfo");c.name=e.name,c.email=e.email,c._csrf=e._csrf,c.id=e.id,d.remove("userinfo"),c.$digest()}b.initMod="signIn",a.addListener("",function(){return c.name?(location.hash="home",void 0):(b.enter("signIn"),void 0)},-1).addListener("upload",function(){b.enter("upload")}).addListener("upload/:edit",function(){b.enter("upload")}).addListener("back",function(){a.slience(),history.back()}).addListener("home",function(){b.enter("home")}).addListener("home/:refresh",function(){b.enter("home")}).addListener("detail/:id",function(){b.enter("detail")}).addListener("explore",function(){b.enter("explore")}),b.addListener("start",function(a){return"upload"!==a&&"home"!==a||c.email?(document.getElementById("nav-btn-home").classList.remove("active"),document.getElementById("nav-btn-explore").classList.remove("active"),$(".nav .icon-white").removeClass("icon-white"),"home"===a?(document.getElementById("nav-btn-home").classList.add("active"),document.querySelector("#nav-btn-home i").classList.add("icon-white")):"explore"===a&&(document.getElementById("nav-btn-explore").classList.add("active"),document.querySelector("#nav-btn-explore i").classList.add("icon-white")),void 0):"#"}),a.other(function(){return c.username?(location.hash="home",void 0):(location.hash="",void 0)})}]),window.Utils={cookies:{get:function(a){if(document.cookie.length>0){var b=document.cookie.indexOf(a+"=");if(-1!==b){b+=a.length+1;var c=document.cookie.indexOf(";",b);return-1===c&&(c=document.cookie.length),unescape(document.cookie.substr(b,c))}}return null},set:function(a,b,c){document.cookie=a+"="+escape(b)+(c?";expires="+new Date(Date.now()+c).toUTCString():"")},remove:function(a){this.set(a,"",-3600)}},syncQueue:function(){function a(){this._queue=[],this._index=0}return a.prototype={push:function(a){return this._queue.push(a),this},exec:function(a){var b=function(a,c){if(b.index++,!(b.index>=b.queue.length)){if(a){for(;b.index<b.queue.length;){if(b.queue[b.index]&&3===b.queue[b.index].length)return b.queue[b.index](a,c,b);b.index++}throw a}var d=b.queue[b.index].length;2===d?b.queue[b.index](c,b):3===d&&b.queue[b.index](null,c,b)}};b.index=-1,b.queue=this._queue,b(null,a)}},a}()},angular.module("HashManager",[]).provider("HashManager",function(){console.log("load HashManager");var a=[],b=null,c={},d=!1;this.addListener=function(b,c,d){void 0===d&&(d=0);for(var e=/:([^\/]*)/g,f=e.exec(b),g=[];null!==f;)g.push(f[1]),f=e.exec(b);for(var h=b.replace(e,"([^/]*)"),i={urlReg:"^"+h+"$",args:g,"function":c,priority:d},j=!1,k=0,l=a.length;l>k;k++)a[k].priority<d&&(a.splice(k,0,i),j=!0);return j||a.push(i),this},this.other=function(a){b=a},this.slience=function(){d=!0},this.$get=function(){var a=this;return{addListener:function(b,c,d){return a.addListener(b,c,d),this},getArgs:function(){return c},other:a.other,slience:function(){d=!0}}};var e=function(){if(d)return d=!1;for(var e=0,f=a.length;f>e;e++){var g=new RegExp(a[e].urlReg),h=window.location.hash;"#"===h[0]&&(h=h.substr(1));var i=h.match(g);if(null!==i){for(var j={},k=1;k<=a[e].args.length;k++)j[a[e].args[k-1]]=i[k];return c=j,a[e]["function"](j),void 0}}null!==b&&(c=[],b())};window.addEventListener("hashchange",e),window.addEventListener("load",e)}),angular.module("myApp.services",["ng","HashManager","ngSanitize"]).value("version","0.1").provider("area",function(){function a(a,c,d){if(1===arguments.length&&"string"==typeof arguments[0])return b[a];2===arguments.length&&(d=c,c=void 0);var e={};d(e),"string"==typeof a&&(b[a]=e)}var b={};this.$get=function(){return a}}).provider("User",function(){var a;angular.injector(["ng"]).invoke(["$rootScope",function(b){a=b.$new(),a.eatCookie=function(){var b=Utils.cookies,c=JSON.parse(b.get("userinfo"));return c?(a.name=c.name,a.email=c.email,a._csrf=c._csrf,a.id=c.id,b.remove("userinfo"),a.$digest(),!0):!1},a.eatCookie.$inject=["cookie"]}]),this.$get=function(){return a}}).provider("Util",function(){var a=function(){var a,b,c,d=angular.element("<div ng-show='visible' class='alert notice'><button type='button' class='close' ng-click='close()'>×</button><span>{{msg}}</span></div>"),e=angular.element("<div ng-show='visible' class='tooltip bottom fade in'><div class='tooltip-arrow'></div><div class='tooltip-inner' ng-bind-html='tooltip'></div></div>");angular.injector(["ng","ngSanitize"]).invoke(["$rootScope","$compile","$sanitize",function(d,e){a=d.$new(),b=d.$new(),c=e}]),a.close=function(){a.visible=!1},a.visible=!1,b.visible=!1;var f=c(d)(a,function(a){document.body.appendChild(a[0])}),g=c(e)(b,function(a){document.body.appendChild(a[0])}),h=function(a){a.timer||(a.timer=setInterval(function(){a.ttl=a.ttl-100,a.ttl<=0&&(clearInterval(a.timer),a.ttl=0,a.timer=null,a.visible=!1,a.$digest())},100))};return function(c,d,e){if(null===c)return a.ttl=0,b.ttl=0,void 0;if(e){b.ttl=d||5e3,h(b),b.tooltip=c,b.visible=!0,b.$digest();var i=$(e).offset(),j={height:e.offsetHeight};g[0].style.position="absolute",g[0].style.left=i.left+"px",g[0].style.top=i.top+j.height+"px"}else a.ttl=d||5e3,h(a),a.msg=c,a.visible=!0,a.$digest(),f[0].style.left=(window.innerWidth-f[0].offsetWidth)/2+"px"}}(),b=function(a,b){function c(a){a||(a=new Date);var b,c=a,d=c.getFullYear(),e=c.getMonth(),g=(c.getDay(),c.getDate()),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],i=[31,0===d%4?29:0===d%100&&0===d%400?29:28,31,30,31,30,31,31,30,31,30,31],j=new Date(d,e,1).getDay(),k=j,l=document.createElement("tr"),m="cal-today",n="cal-title",o="cal-close",p="cal-first-line";f.className=n,f.innerHTML=f.innerHTML='<span class="cal-btn"><i data-pre="true" class="icon-chevron-left icon-white"></i></span><span class="cal-title-text">'+a.getFullYear()+", "+(a.getMonth()+1)+'</span><span class="cal-btn"><i data-next="true" class="icon-chevron-right icon-white"></i></span><span class="'+o+' cal-btn"><i class="icon-remove icon-white" data-close="true"></i></span>',b=document.createElement("table"),l.className="cal-firstTr";for(var q=0;7>q;q++)l.innerHTML+="<th class='"+p+"'>"+h[q]+"</th>";b.appendChild(l),l=document.createElement("tr");for(var q=0;k>q;q++)l.innerHTML+="<td></td>";for(var q=1,r=i[e];r>=q;q++)l.innerHTML+=q===g&&a.getMonth()===(new Date).getMonth()?"<td class='"+m+"'>"+q+"</td>":"<td>"+q+"</td>",6!==k?k++:(k=0,b.appendChild(l),l=document.createElement("tr"));if(0!==k)for(var q=k;6>=q;q++)l.innerHTML+="<td></td>";return b.appendChild(l),b}function d(c){c.addEventListener("click",function(c){var d=c.target;"TD"===d.tagName&&""!==d.innerHTML&&b(new Date(a.setDate(+d.innerHTML)))},!1)}var e=document.createElement("div"),f=document.createElement("div");a||(a=new Date),f.addEventListener("click",function(g){var h=g.target;if("I"===h.tagName||$(h).hasClass("cal-btn")){$(h).hasClass("cal-btn")&&(h=h.childNodes[0]),"true"==h.dataset.pre?a.setMonth(a.getMonth()-1):"true"===h.dataset.next?a.setMonth(a.getMonth()+1):"true"===h.dataset.close&&(b(null),e.parentNode.removeChild(e));var i=e.getElementsByTagName("TABLE")[0];i.parentElement.removeChild(i),i=c(a),d(i),e.appendChild(i),f.getElementsByClassName("cal-title-text")[0].innerHTML=a.getFullYear()+", "+(a.getMonth()+1)}},!1);var g=c(a);return d(g),e.appendChild(f),e.appendChild(g),e},c=function(){var a='<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .5); display: none; "></div>',b=angular.element(a)[0];document.body.appendChild(b);var c=[],d=[],e=[],f=function(a,e,g,h){if(arguments.length<3&&(g=e,e="PLEXI"),g=g||1e3,g>0&&(b.style.zIndex=g),e&&a&&-1===c.indexOf(e)&&(c.push(e),d[e]=h),e&&!a){var i=c.splice(c.indexOf(e),1)[0];d[i].forEach(function(a){a.classList.remove(f.CLEAR_CLASS)}),delete d[i]}b.style.display=c.length>0?"block":"none",h&&h.constructor===Array&&h.forEach(function(a){a.classList.add(f.CLEAR_CLASS)})};return f.CLEAR_CLASS="clear-plexi",f.push=function(b,c){var d=angular.element(a)[0];d.style.display="block",d.style.zIndex=b||1e3,document.body.appendChild(d),c&&c.constructor===Array&&c.forEach(function(a){a.classList.add(f.CLEAR_CLASS)}),e.push({plexi:d,clear:c})},f.remove=function(){var a=e.pop();a&&(a.plexi.parentNode.removeChild(a.plexi),a.clear.forEach(function(a){a.classList.remove(f.CLEAR_CLASS)}))},f}(),d=function(a,b,c){var d,e,f;if(c||(c="image/jpeg"),"string"==typeof a&&(d=new Image,d.src=a,!d.complete))return alert("Please enable browser cache!"),null;switch(b){case 2:return a;case 0:var g=d.height,h=d.width;if(g>=h&&g>1440){var i=g/1440;g=1440,h/=i}else if(h>g&&h>1440){var i=h/1440;g/=i,h=1440}return e=document.createElement("canvas"),e.width=h,e.height=g,f=e.getContext("2d"),f.drawImage(d,0,0,h,g),"image/jpeg"===c?e.toDataURL(c,.75):e.toDataURL(c);case 1:var g=d.height,h=d.width;if(g>=h&&g>1024){var i=g/1024;g=1024,h/=i}else if(h>g&&h>1024){var i=h/1024;g/=i,h=1024}return e=document.createElement("canvas"),e.width=h,e.height=g,f=e.getContext("2d"),f.drawImage(d,0,0,h,g),"image/jpeg"===c?e.toDataURL(c,.75):e.toDataURL(c)}},e=function(){var a="jxoq532nm#$d",b=[],c={get:function(){return localStorage[a+"_settings"]?JSON.parse(localStorage[a+"_settings"]):{}},set:function(b){localStorage[a+"_settings"]=JSON.stringify(b)}},d=function(a,d){var e=c.get()[a];b.forEach(function(b){if(b.key===a){var c=b.callback(a,e,d);if(c)return!0}})},e={set:function(a,b){var e=d(a,b);if(e)return!1;var f=c.get();return f[a]=b,c.set(f),!0},get:function(a,b){var d=c.get();return d[a]||b},watch:function(a,c){b.forEach(function(b){b.key===a&&b.callback===c}),b.push({key:a,callback:c})},unwatch:function(a,c){b.forEach(function(d,e){return d.key===a&&d.callback===c?b.splice(e,1):void 0})},once:function(a,b){var c=this;this.watch(a,function d(a,e,f){b(a,e,f),c.unwatch(a,d)})}};return e}(),f={notice:a,getDatePicker:b,plexi:c,settings:e,getCompressedImage:d};this.$get=function(){return f}}).provider("Item",function(){this.$get=function(){return{empty:function(){return[this.one()]},one:function(){return{pictures:[],post:""}},picture:function(a,b){var c=new Image;return c.src=a,{src:a,progress:0,file:b,img:c}}}}}).provider("ModManager",["HashManagerProvider",function(){var a=null,b=function(a,b,c,d){document.getElementById("mod-"+a),document.getElementById("mod-"+b),$("#mod-"+a).css({"-webkit-transform":"translateX(-50px)",opacity:0}),setTimeout(function(){$("#mod-"+a).css({display:"none","-webkit-transform":"translateX(0px)",opacity:1}),$("#mod-"+b).css({display:"block",opacity:0,"-webkit-transform":"translateX(50px)"}),setTimeout(function(){$("#mod-"+b).css({"-webkit-transform":"translateX(0px)",opacity:1}),document.getElementById("mod-"+b).style.removeProperty("-webkit-transform")},0),c(),setTimeout(function(){d()},300)},300)},c=!1,d=!1,e=[],f=[],g=[],h=[],i=function(a){switch(a){case"before":return e;case"after":return f;case"unload":return g;case"start":return h}return null},j=function(a,b){for(var c=i(a),d=!1,e=c.length;e--;)if(d=c[e](b),"start"===a&&d)return d},k=function(e,f){if(c!==!1)return d=e,void 0;c=!0;var g=j("start",e);return g?(location.hash=g,c=!1,d&&k(d),void 0):(null===a&&(a=l.initMod),"function"!=typeof f&&(f=b),j("before",e),l.firstLoad?(l.firstLoad=!1,a=e,j("after",e),c=!1,d&&(k(d),d=!1),document.getElementById("mod-"+l.initMod).style.display="none",document.getElementById("mod-"+e).style.display="block",void 0):(f(a,e,function(){j("unload",a)},function(){j("after",e),document.body.style.overflow="auto",a=e,c=!1,d&&(k(d),d=!1)}),void 0))},l=this;this.initMod=null,this.firstLoad=!0,this.enter=k,this.data=null,this.$get=function(){return{enter:k,addListener:function(a,b){var c=i(a);c.push(b)},removeListener:function(a,b){for(var c=i(a),d=c.length;d--;)if(c[d]===b)return c.splice(d,1),!0;return!1},get currentMod(){return a},set initMod(a){l.initMod=a},setData:function(a){l.data=a},getData:function(){return l.data}}}}]),angular.module("myApp.controllers",[]).controller("SignInCtrl",["$scope","$http","ModManager","Util","User",function(a,b,c,d,e){a.loginBoxDesc="Sign up right now!",a.loginBtn="Sign In",a.showEmail=!1,a.errorMessage="";var f=!1;a.getOpacity=function(){return{opacity:a.submiting?.3:1}},a.signUp=function(b){if(!a.submiting){if(f=!f){a.loginBtn="Sign Up",a.loginBoxDesc="Already have an account.",a.showEmail=!0;var c=$("#login-email").height();$("#login-email, #login-repassword").css({height:0,opacity:0}),$("#login-email, #login-repassword").animate({height:c,opacity:1},200)}else a.loginBtn="Sign In",a.loginBoxDesc="Sign up right now!",a.showEmail=!1;!!b&&b.preventDefault()}},a.submit=function(){if(!a.submiting){var c=/^[^_]([a-zA-Z0-9\u4e00-\u9fa5]+_?)+[^_]$/;if(f&&!c.test(a.inputUsername))return alert("用户名非法");if(!a.inputUsername||!a.inputPassword)return a.errorMessage="表格要完整才可以呈上~";if(f&&!a.inputEmail)return a.errorMessage="表格要完整才可以呈上~";if(a.inputUsername<5)return a.errorMessage="用户名必须大于5个字符";if(f&&a.inputPassword!==a.inputRepassword)return a.errorMessage="两次输入的密码不相同";if(!document.getElementById("login-email").validity.valid)return a.errorMessage="请输入正确的电子邮箱";a.submiting=!0,f?b({method:"POST",url:"/signup",data:{name:a.inputUsername,email:a.inputEmail,passwd:hex_md5(a.inputPassword),repasswd:hex_md5(a.inputRepassword)}}).success(function(b){a.submiting=!1,1===b.status?(a.errorMessage="创建成功~",a.inputPassword="",a.signUp()):(window.location.hash="",a.errorMessage=b.message,$("#login-btn").css("opacity","1"))}).error(function(){a.submiting=!1}):b({method:"POST",url:"/signin",data:{name:a.inputUsername,passwd:hex_md5(a.inputPassword)}}).success(function(b){a.submiting=!1,$("#login-btn").css("opacity","1"),1===b.status?e.eatCookie()&&(window.location.hash="home"):(window.location.hash="",a.errorMessage=b.message,$("#login-btn").css("opacity","1"))}).error(function(){a.submiting=!1,$("#login-btn").css("opacity","1"),window.location.hash=""})}},$("#login-password").keydown(function(b){13===b.keyCode&&a.submit()}),c.addListener("before",function(b){"signIn"===b&&(setTimeout(function c(){document.getElementById("login-username").focus(),document.activeElement!==document.getElementById("login-username")&&setTimeout(c,100)},300),a.$emit("NavCtrl.hide"))}),c.addListener("unload",function(b){"signIn"===b&&a.$emit("NavCtrl.show")})}]).controller("ExploreCtrl",["$scope","$http","User","ModManager","area",function(a,b,c,d,e){a.marks=[];var f;e("ExploreCtrl.msry","define msry",function(b){function c(){return $(".explore-container").masonry({itemSelector:".explore-mark",columnWidth:442,gutter:10})}var d,e=0;b.msry={get:function(){return d},set:function(a){d=a}},a.switchMode=function(){e=!e,e?(d=c(),document.querySelector(".explore-container").classList.add("tworows"),setTimeout(function(){d=c()},0)):d&&(d.masonry("destroy"),d=null,document.querySelector(".explore-container").classList.remove("tworows"))}}),a.getAvatar=function(a){return"http://www.gravatar.com/avatar/"+a+"?s=24&d=mm"},a.goDetail=function(b){for(;"LI"!==b.target.tagName;)b.target=b.target.parentElement;var c=b.target.dataset.itemNo;location.hash="#detail/"+a.marks[c]._id},d.addListener("before",function(c){if("explore"===c){var d=e("ExploreCtrl.msry").msry;f||(d.get()&&(displayMode=!displayMode,d.get().masonry("destroy"),d.set(null),document.querySelector(".explore-container").classList.remove("tworows")),b.get("/mark/explore?type=latest").success(function(b){return-1===b.status?alert("TODO: Error!"):(a.marks=b,f=!0,void 0)}).error(function(){}))}})}]).controller("NavCtrl",["$scope","$http","User","$rootScope",function(a,b,c,d){function e(){c.email&&(a.avatar="http://www.gravatar.com/avatar/"+hex_md5(c.email)+"?s=32&"+"d=mm",a.email=c.email,a.signout="signout?_csrf="+c._csrf)}a.hideNav=!1,c.$watch("name",function(a){a&&e()}),setTimeout(e,0),d.$on("NavCtrl.hide",function(){a.hideNav=!0,a.$digest()}),d.$on("NavCtrl.show",function(){a.hideNav=!1,a.$digest()})}]).controller("HomeCtrl",["$scope","$http","ModManager","User","HashManager",function(a,b,c,d,e){function f(){b({method:"GET",url:"/mark/get"}).success(function(b){a.marks=b.marks,a.totalMarks=b.totalMarks,a.totalPictures=b.totalPictures})}var g=!1;a.totalMarks=0,a.totalPictures=0,a.marks=[],document.getElementById("signIn-cover").style.backgroundImage="url(img/samples/"+Math.round(6*Math.random()+1)+".jpg)",a.filterDate=function(a){return new Date(a).toLocaleString()},a.modeSwitch=function(a){switch($(".mark").css({"margin-top":10,"border-bottom-width":"3px"}),$(".marks-container").removeClass("list"),a){case"middle":$(".mark").animate({height:"200px"});break;case"small":$(".mark").animate({height:"100px"});break;case"large":$(".mark").animate({height:"400px"});break;case"list":$(".mark").animate({height:"40px"}),$(".marks-container").addClass("list"),$(".mark").css({"margin-top":0,"margin-bottom":0,"border-bottom-width":0})}},a.goTo=function(a){location.hash="detail/"+a},c.addListener("before",function(a){if("home"===a){if(!d.email)return;(!g||e.getArgs().refresh)&&(g=!0,f())}})}]).controller("DetailCtrl",["$scope","$http","HashManager","ModManager","User","$rootScope","area","Util",function(a,b,c,d,e,f,g){function h(a){return a=new Date(a),a.getMonth()+1+"-"+a.getDate()+"-"+a.getFullYear()}var i,j=null;a.title="",a.location="",a.read=32,a.author="",a.summary="",a.total=0,a.date="";var k={one:function(){return{pictures:[],post:""}},empty:function(){return[this.one()]},picture:function(a){return{src:a,loaded:!1}}},l=function(b){-1!==b.status&&(i=b,i.id=c.getArgs().id,a.id=c.getArgs().id,a.title=b.title,a.location=b.location,a.read=b.read,a.author=b.author,a.summary=b.summary,a.total=b.total,a.date=b.date,a.editable=a.author===e.name?!0:!1,a.items=[],b.items.forEach(function(b){var c=k.one();c._id=b._id,c.post=b.post,c.title=b.title,c.date=h(b.date),c.tag=b.tag,c.tag.uid=parseInt(1e4*Math.random())+""+parseInt(1e4*Math.random()),b.pictures.forEach(function(b){var d=k.picture(b),e=new Image;if(e.src=b,e.complete){d.loaded=!0;try{a.$digest()}catch(f){}}else e.onload=function(){d.loaded=!0;try{a.$digest()}catch(b){}};c.pictures.push(d)}),a.items.push(c)}),i.items=a.items)};a.edit=function(){d.setData(i),location.hash="upload/edit"},a.remove=function(){var c=prompt("Do you really want to delete this mark? Enter DELETE to continue.");if("DELETE"===c){var d=a.id;b({method:"post",url:"/mark/delete",data:{markId:d,_csrf:e._csrf}}).success(function(a){return 1===a.status?location.hash="home/refresh":void 0}).error(function(){})}},a.dateFilter=function(a,b){var a=new Date(a);switch(b){case 0:return a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate();case 1:return a.getMonth()+1+"."+a.getDate()}},g("UploadCtrl.msry","2-row mode",function(b){var c,d=!1;a.getMode=function(){return d?"tworows":""},a.switchMode=function(){return(d=!d)?(c=$(".item-box li").masonry({itemSelector:".it-pic-container, .it-post, .item-date",columnWidth:435}),setTimeout(function(){c=$(".item-box li").masonry({itemSelector:".it-pic-container, .it-post, .item-date",columnWidth:435,gutter:5})},20),void 0):(c&&(c.masonry("destroy"),c=null),void 0)},b.mode2rows={get:function(){return d},set:function(a){d=a}},b.msry={get:function(){return c},set:function(a){c=a}}}),a.ifLoad=function(b,c){return a.items[b].pictures[c].loaded?"loaded":""},d.addListener("before",function(d){var e=g("UploadCtrl.msry");e.mode2rows.set(!1),e.msry.get()&&(e.msry.get().masonry("destroy"),e.msry.set(null)),"detail"===d&&c.getArgs().id!==j&&(a.title="",a.location="",a.read=0,a.author="",a.summary="",a.total=0,a.date="",a.items=[],j=c.getArgs().id,setTimeout(function(){document.body.scrollTop=0},300),a.items=k.empty(),b({method:"GET",url:"mark/getMark",params:{id:c.getArgs().id}}).success(l),a.$digest())}),f.$on("DetailCtrl.clearCache",function(){j=null})}]).controller("UploadCtrl",["$scope","$http","ModManager","Item","$q","Util","HashManager","area",function(a,b,c,d,e,f,g,h){function i(a){for(;null!==a;){if(void 0!==a.dataset.itemNo)return a.dataset.itemNo;a=a.parentElement}return-1}var j;a.locTags=[],a.items=d.empty(),a.uploading=!1;var k,l,m=new google.maps.places.PlacesService(document.createElement("div"));a.demoUploadFinished=0,a.addMore=function(){a.items.push(d.one()),a.items[a.items.length-1].tag=a.locTags[a.locTags.length-1]};var n=function(){if(!f.settings.get("upload-tips",!1)&&"edit"!==g.getArgs().edit){f.settings.set("upload-tips",!0);var a=new Utils.syncQueue;a.push(function(a,b){var c=document.getElementById("upload-title-input");f.notice("<strong>Step 1.</strong> Give your mark a name. (press enter to next step)",99999,c),$(document).one("keydown",function d(a){return 13!==a.keyCode?$(document).one("keydown",d):(f.plexi(!1,"title"),b(null),void 0)}),f.plexi(!0,"title",0,[c.parentNode])}).push(function(a,b){var c=document.getElementById("upload-location-input");f.notice("<strong>Step 2.</strong> Type a place and PRESS ENTER.",99999,c),$(document).one("keydown",function d(a){return 13!==a.keyCode?$(document).one("keydown",d):(a.preventDefault(),f.plexi(!1,"location"),b(null),void 0)}),f.plexi(!0,"location",0,[c.parentNode])}).push(function(a,b){var c=document.querySelector("#mod-upload textarea");c.focus(),f.notice("<strong>Step 3.</strong> Here your story begins... (press enter to next step)",99999,c),$(document).one("keydown",function d(a){return 13!==a.keyCode?$(document).one("keydown",d):(a.preventDefault(),f.notice(null),f.plexi(!1,"summary"),b(null),void 0)}),f.plexi(!0,"summary",0,[c.parentNode])}).push(function(a,b){var c=angular.element('<div style="position: fixed; background-color: #E9A782; color: white;"></div>')[0],d=document.querySelector("#mod-upload .item-box").getBoundingClientRect();c.style.left=d.left+"px",c.style.top=d.top+"px",c.style.width=d.right-d.left+"px",c.style.height=d.bottom-d.top+"px",c.innerHTML='<div style="padding: 10px; font-size: 20px; margin-top: 60px; text-align: center;">A mark is composed of sites. And each site consists of a title, a description and some pictures.</div>',document.body.appendChild(c),f.plexi(!0,"item",0,[c]),setTimeout(function(){document.querySelector("#mod-upload .item-box li .it-post-title").focus(),c.parentNode.removeChild(c),f.plexi(!1,"item")},6e3)}).exec()}};a.progressWidth=function(a){return $(document.getElementsByClassName("upload-pictures")[0]).hasClass("uploading")?216*(a.progress/100)+"px":"220px"},a.getModTitle=function(){return a.editMode?"Editing Mark":"Create a Mark!"},a.ifUploading=function(){return a.uploading?"disable-buttons":""},a.removeItem=function(b){var c=i(b.target);a.items.splice(c,1),b.preventDefault(),b.stopPropagation()};var o=0;a.upload=function(a){for(var b=a.target;b;){if($(b).hasClass("upload-pictures-list"))return;b=b.parentNode}o=i(a.target),angular.element(".upload-input")[0].click()},a.save=function(){function c(a){t.push(function(c,d){var e={markId:s,name:a.name,addr:a.pos,lat:a.results[a.activeTag].geometry.location.lat(),lng:a.results[a.activeTag].geometry.location.lng()};b({method:"post",url:"tag/create",data:e}).success(function(b){1===b.status&&(a.tagId=b.data.tagId,a.id=b.data.tagId,d(null,a.tagId))}).error(function(){d(new Error("Upload failed"))})})}function e(c){var d;t.push(function(e,f){var g=a.items[c].tag;b({method:"POST",url:"item/create",data:{markId:s,date:new Date(a.items[c].date).getTime(),post:a.items[c].post,title:a.items[c].title,tag:g.tagId}}).success(function(a){1===a.status&&(d=a.data.itemId,f(null,a.data.itemId))}).error(function(){f(new Error("Upload failed."))})}),a.items[c].pictures.forEach(function(b,c){g(d,b,c),a.demoUploadFinished++})}function g(b,c){t.push(function(b,d){var e=b,g=new FormData,h="file",i="/picture/save";if(1===a.quality.code&&Math.max(c.img.width,c.img.height)>1440||(0===a.quality.code&&Math.max(c.img.width,c.img.height))>1024){var j=f.getCompressedImage(c.src,a.quality.code,c.file.type);h="base64",window.test=j,g.append("image",j.substr(j.indexOf("base64,")+"base64,".length)),g.append("oriname",c.file.name),i+="/base64"}else g.append("image",c.file);g.append("type",h),g.append("itemId",e);var k=new XMLHttpRequest;k.open("POST",i),k.onload=function(){var a=JSON.parse(k.response);-1===a.status&&d(a),d(null,e)},k.send(g);var l=parseInt(10+10*Math.random());setTimeout(function m(){c.progress++,a.$digest(),c.progress<100?setTimeout(m,l):a.demoUploadFinished--},l)})}if(!a.uploading){a.uploading=!0;var h,i=!0;if(a.items.forEach(function(a){a.tag||(h="You need to select a location tag for each site.",i=!1),a.title||(h="Item's title is required.",i=!1)}),a.title&&a.summary||(i=!1,h="Cannot create a mark without title and summary."),!i)return alert(h),a.uploading=!1,void 0;if(a.editMode){var j=[],m=0,n=!1,o=function(){--m>0||!n||(a.$emit("DetailCtrl.clearCache"),location.hash="detail/"+a.id,a.uploading=!1)};(a.title!==k.title||a.summary!==k.summary)&&j.push(function(){m++,b({method:"post",url:"mark/alter",data:{_id:a.id,title:a.title,summary:a.summary}}).success(function(){o("mark change")})});var p=[];a.locTags.forEach(function(a,b){"_id"in a||"id"in a||p.push({tag:a,index:b})});var q=0;j.push(function(){p.forEach(function(c){b({method:"post",url:"tag/create",data:{markId:a.id,name:c.tag.name,addr:c.tag.pos,lat:c.tag.results[c.tag.activeTag].geometry.location.jb,lng:c.tag.results[c.tag.activeTag].geometry.location.kb}}).success(function(b){c.tag._id=b.data.tagId,a.locTags[c.index].id=b.data.tagId,r()}),q++}),0===p.length&&r()});var r=function(){function c(a){var b=[];return a.forEach(function(a){if("string"==typeof a)b.push(a);else{if(!("src"in a&&-1!==a.src.indexOf("user_data")))throw new Error("图片格式错误");b.push(a.src)}}),b}function d(a){var b=null;return l.forEach(function(c,d){b||c._id===a&&(b=d)}),null===b?-1:b}function e(){--g>0}if(!(--q>0)){var g=0,h=function(){a.items.forEach(function(h){var i=!1,j=0,k=d(h._id);l[k]&&h.title===l[k].title&&h.post===l[k].post&&new Date(h.date).getTime()===new Date(l[k].date).getTime()&&h.tag._id===l[k].tag._id||(i=!0),l[k]&&l[k].pictures&&l[k].pictures.forEach(function(a,b){a!==h.pictures[b]&&(i=!0)}),h.pictures.forEach(function(b,c){"string"==typeof b||"loaded"in b||(j++,function(c){var d=new FormData,e="picture/save",g="file";if(1===a.quality.code&&Math.max(b.img.width,b.img.height)>1440||(0===a.quality.code&&Math.max(b.img.width,b.img.height))>1024){var i=f.getCompressedImage(b.src,a.quality.code,b.file.type);g="base64",window.test=i,d.append("image",i.substr(i.indexOf("base64,")+"base64,".length)),d.append("oriname",b.file.name),e+="/base64"}else d.append("image",b.file);d.append("type",g),d.append("itemId",h._id);var j=new XMLHttpRequest;j.open("POST",e),j.onload=function(){var a=JSON.parse(j.response);return-1===a.status?alert("上传失败"):(h.pictures[c]=a.data.url,p(),void 0)},j.send(d)}(c))}),(i||j)&&(g++,m++),n=!0;var p=function(){--j>0||q()},q=function(){b({method:"post",url:"item/alter",data:{_id:h._id,post:h.post,tag:h.tag._id||h.tag.id,title:h.title,pictures:c(h.pictures),date:h.date}}).success(function(a){1===a.status&&(o("picture"),e())})};!j&&i&&q()})},i=function(c){var d=[];l.forEach(function(b){var c=b._id,e=!1;a.items.forEach(function(a){a._id===c&&(e=!0)}),e||d.push(b)});var e=d.length;d.forEach(function(d){b({method:"GET",url:"item/delete?itemId="+d._id}).success(function(){--e<=0&&"function"==typeof c&&c()}).error(function(){return alert("Error occured"),a.uploading=!1})})};i();var j=new Utils.syncQueue;a.items.forEach(function(c,d){"_id"in c||(m++,j.push(function(c,e){var f=a.items[d].tag;b({method:"POST",url:"item/create",data:{markId:a.id,date:new Date(a.items[d].date).getTime(),post:a.items[d].post,title:a.items[d].title,tag:f.id}}).success(function(b){o("create item"),1===b.status&&(a.items[d]._id=b.data.itemId,e(null,b.data.itemId))}).error(function(){o(),a.uploading=!1,e(new Error("Upload failed."))})}))}),j.push(function(a,b){h()}).exec()}};return setTimeout(function(){0>=m&&a.uploading&&0>=q&&"#upload/edit"===location.hash&&(history.back(),a.uploading=!1)},300),j.forEach(function(a){a()}),void 0}$(".upload-pictures").addClass("uploading");var s,t=new Utils.syncQueue;t.push(function(c,d){b({method:"POST",url:"mark/create",data:JSON.stringify({title:a.title,summary:a.summary})}).success(function(b){return-1===b.status?(a.uploading=!1,d(b)):(s=b.data.markId,d(null,b.data.markId),void 0)}).error(function(){alert("Upload failed. Please try again later.")})}),a.locTags.forEach(function(a){c(a)}),a.items.forEach(function(a,b){(a.post||0!==a.pictures.length)&&e(b)}),t.push(function v(b,c){if(a.demoUploadFinished>0)return setTimeout(v,200);a.uploading=!1,$(".upload-pictures").removeClass("uploading"),a.items=d.empty(),a.title="",a.summary="",a.location="";try{a.$digest()}catch(e){}location.hash="detail/"+s}).push(function(a,b,c){return a?("object"==typeof a&&"status"in a&&alert(a.message),void 0):c(null,b)}).exec();try{a.$digest()}catch(u){}}},c.addListener("before",function(b){if("upload"===b){if(a.editMode=!1,a.title="",a.summary="",a.locTags=[],a.items=d.empty(),"edit"===g.getArgs().edit){a.editMode=!0;var e=c.getData();if(!e)return history.back();k=e,l=[],k.items.forEach(function(a,b){var c={title:a.title,date:a.date,_id:a._id,post:a.post,tag:{_id:a.tag._id},pictures:k.items[b].pictures.slice()};l[b]=c}),c.setData(null),a.title=e.title,a.author=e.author,a.summary=e.summary,a.locTags=[],a.id=e.id;var f=[];e.items.forEach(function(b){var c=b.tag;if(!(c._id in f)){f[c._id]=!0,b.addr=c.addr||"loading...",b.pos=b.addr,a.locTags.push({id:c._id,name:c.name,geometry:{lat:c.lat,lng:c.lng},uid:c.uid,pos:c.addr||"loading...",results:[{formatted_address:c.addr||c.name,geometry:{location:{lat:function(){return this.geometry.lat},lng:function(){return this.geometry.lng}}}}],activeTag:0});var d=a.locTags.length-1;b.addr?a.locTags[d].pos=b.addr:m.nearbySearch({location:new google.maps.LatLng(c.lat,c.lng),radius:5},function(b){a.locTags[d].pos=b[0].vicinity})}}),a.items=e.items,a.$digest()}a.$digest()}}),c.addListener("after",function(a){"upload"===a&&(setTimeout(function b(){var a=document.getElementById("upload-title-input");a.focus(),document.activeElement!==a&&setTimeout(b,100)},100),setTimeout(n,300))}),$("#upload-title-input").keydown(function(a){13===a.keyCode&&($("#upload-location-input").focus(),a.preventDefault())}),$("#upload-location-input").bind("keydown",function(b){if(13===b.keyCode){if(""===$.trim(b.target.value))return;a.locTags.push({name:b.target.value,pos:"loading...",uid:parseInt(1e4*Math.random())+parseInt(1e4*Math.random())}),a.$digest();var c=a.locTags.length-1,d=b.target.value,e=new google.maps.places.PlacesService(document.createElement("div"));b.target.value="",e.textSearch({query:d},function(b){if(0===b.length)return a.locTags.splice(c,1),alert("not found");a.locTags[c].results=b,a.locTags[c].activeTag=0,a.locTags[c].pos=b[0].formatted_address;for(var d=$("#mod-upload .item-box li"),e=d.length;e--;)a.items[e].tag||(a.items[e].tag=a.locTags[a.locTags.length-1]);a.$digest()})}}),$("#mod-upload .item-box").delegate(".item-tag","click",function(a){if(j===a.target&&p.show)return p.show=!1,p.$digest();j=a.target,p.currentTarget=a.target,p.show=!0;var b=$(a.target).offset();b.bottom=b.top+a.target.offsetHeight,b.right=b.left+a.target.offsetWidth,p.$digest(),q[0].style.top=b.bottom+"px",q[0].style.left=b.right-q[0].offsetWidth+"px"}),$(".location-tags-container").delegate(".location-tag","click",function(b){for(t=!0;!("itemOrder"in b.target.dataset);)b.target=b.target.parentNode;var c=b.target;document.getElementsByClassName("upload-location-selector")[0];var d=+c.dataset.itemOrder;r.selectIndex=0,r.show=!0,r.result=a.locTags[d].name+" - "+a.locTags[d].pos,r.inputName=a.locTags[d].name,r.inputPos=a.locTags[d].pos,r.results=a.locTags[d].results,r.order=d,r.$digest();var e=$(c).offset();s[0]._bindElement=c,s[0].style.top=e.top-9+"px",s[0].style.left=e.left-22+"px",b.stopPropagation(),document.querySelector(".upload-location-selector .selector-input-pos").focus(),$(document).one("click",function f(a){if(r.show){for(var b=a.target;b&&b.classList;){if(b.classList.contains("upload-location-selector"))return r.show&&$(document).one("click",f),void 0;
b=b.parentNode}$(".selector-results .select").removeClass(".select"),r.show=!1,s[0]._bindElement=null,r.$digest()}})}),$("#mod-upload .item-box").delegate(".upload-pictures-list","click",function(b){b.stopPropagation(),b.preventDefault();for(var c=b.target;!c.dataset.order;)c=c.parentNode;var d=i(c);return a.items[d].pictures.splice(+c.dataset.order,1),a.$digest(),!1}),h("drop to upload pictures",function(){var a=!1;document.addEventListener("dragenter",function(b){return a||"Files"!==b.dataTransfer.types[0]||(a=!0,document.body.classList.add("dragenter")),b.preventDefault(),!1},!1),document.addEventListener("dragover",function(b){return a||"Files"!==b.dataTransfer.types[0]?b.dataTransfer.files.length>0&&(b.dataTransfer.effectAllowed="none",b.dataTransfer.dropEffect="none",b.preventDefault()):(a=!0,document.body.classList.add("dragenter")),(b.target.classList.contains("upload-pictures")||b.target.classList.contains("drop-pictures")||b.target.parentElement&&b.target.parentElement.classList.contains("drop-pictures"))&&"Files"===b.dataTransfer.types[0]?(b.dataTransfer.effectAllowed="all",b.dataTransfer.dropEffect="copy",b.preventDefault()):void 0},!1),document.addEventListener("dragleave",function(b){return 0===b.x&&0===b.y?(document.body.classList.remove("dragenter"),a=!1,b.preventDefault(),!1):void 0},!1)}),$("#mod-upload .item").delegate("input, textarea","focus",function(a){a.target.parentElement.classList.add("focus")}),$("#mod-upload .item").delegate("input, textarea","blur",function(a){a.target.parentElement.classList.remove("focus")}),$("#mod-upload .item").click(function(a){$(a.target).hasClass("item")||(a.target=a.target.parentElement);var b=a.target.getElementsByTagName("input")[0]||a.target.getElementsByTagName("textarea")[0]||a.target.parentNode.parentNode.getElementsByTagName("input")[0];b.focus()}),h("date picker",function(){var b;$(".item-box").delegate(".it-post-date","focus",function(c){var d=c.target;d.blur(),b||(b=f.getDatePicker(null,function(c){return null===c?b=null:(b.parentElement.removeChild(b),b=null,d.dataset.date=c.getTime(),d.value=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),a.items[i(d)].date=d.value,a.$digest(),void 0)}),b.className="date-picker",document.body.appendChild(b))})}),$(document).delegate(".upload-pictures","drop",function(b){for(var c=b.originalEvent.dataTransfer.files,e=0,f=c.length;f>e;e++)if(-1!==c[e].type.indexOf("image")){b.preventDefault();var g=new Worker("js/worker-file-reader.js");g._file=c[e],g.addEventListener("message",function(c){var e=document.createElement("canvas"),f=(e.getContext("2d"),new Image);f.src=c.data,e.width=220,e.height=140,a.items[i(b.target)].pictures.push(d.picture(c.data,this._file)),a.$digest()}),g.postMessage({file:c[e],method:"readAsDataURL"})}document.body.classList.remove("dragenter"),set=!1,b.preventDefault()}),angular.element(".upload-input")[0].addEventListener("change",function(b){var c=new FileReader;c.onload=function(){a.items[o].pictures.push(d.picture(this.result,b.target.files[0])),a.$digest(),angular.element(".upload-input")[0].value=null},c.readAsDataURL(b.target.files[0])},!1);var p,q,r,s,t=!0;angular.injector(["ng"]).invoke(["$rootScope","$compile",function(b,c){r=b.$new(),p=a.$new(),r.deleteTag=function(){var b=a.locTags[r.order].uid;$("#mod-upload .item-box li").each(function(c){a.items[c].tag&&a.items[c].tag.uid===b&&(a.items[c].tag=null)}),a.locTags.splice(r.order,1),a.$digest(),r.show=!1};var d=angular.element('<div ng-show="show" class="upload-location-selector"><div class="selector-nav"><span class="selector-result"><i class="icon-white icon-map-marker"></i><span ng-bind-template="{{result}}" class="result-text"></span></span></div><div class="input-wrap"><input ng-model="inputName" type="text" class="selector-input-name" /></div><div class="input-wrap location"><input type="text" class="selector-input-pos" ng-model="inputPos" /></div><div class="selector-results"><div class="results-item" ng-repeat="it in results" data-item-order="{{$index}}" ng-bind-template="{{it.formatted_address}}"></div><div class="results-footer" ><div ng-click="deleteTag()" class="delete">Delete this tag</div><div class="results-num" ng-bind-template="{{results.length}} result(s)"></div><div class="clear"></div></div></div></div>');s=c(d)(r,function(b){document.body.appendChild(b[0]);var c=b[0].getElementsByClassName("selector-results")[0];c.addEventListener("click",function(b){if(b.target.classList.contains("results-item")){var c=+b.target.dataset.itemOrder;a.locTags[r.order].pos=r.results[c].formatted_address,a.locTags[r.order].results=r.results,a.locTags[r.order].activeTag=c,r.show=!1,a.$digest(),r.$digest(),b.stopPropagation()}});var d=b[0].getElementsByClassName("selector-input-pos")[0];d.addEventListener("keydown",function(a){var b=c.getElementsByTagName("div");switch(a.keyCode){case 38:$(b[r.selectIndex]).removeClass("selected"),r.selectIndex=Math.max(r.selectIndex-1,0),$(b[r.selectIndex]).addClass("selected");break;case 40:$(b[r.selectIndex]).removeClass("selected"),r.selectIndex=Math.min(r.selectIndex+1,b.length-1),$(b[r.selectIndex]).addClass("selected");break;case 13:b[r.selectIndex].click()}});var e,f,g=document.createElement("div"),h=new google.maps.places.PlacesService(g),i=300;r.$watch("inputName",function(b){a.locTags&&r.order&&(a.locTags[r.order].name=b,a.$digest())}),r.$watch("inputPos",function(a,b){function c(){r.inputPos&&h.textSearch({query:r.inputPos},function(a){r.results=a;try{r.$digest()}catch(b){}})}if(void 0!==b){if(t)return t=!1;if(a){if(e)return f=i;f=i,e=setInterval(function(){f-=20,0>=f&&(clearInterval(e),e=null,c())},20),c()}}})}),window.addEventListener("resize",function(){if(s[0]._bindElement){var a=$(s[0]._bindElement).offset();s[0].style.top=a.top-9+"px",s[0].style.left=a.left-22+"px"}}),p.show=!1,d=angular.element("<div ng-show='show' class='tag-selector'><div ng-repeat='tag in locTags' class='tag' data-item-order='{{$index}}' ng-bind-template='{{tag.name}}'></div></div>"),q=c(d)(p,function(b){document.body.appendChild(b[0]),$(b[0]).delegate(".tag","click",function(b){if(this.classList.contains("tag")){var c=i(p.currentTarget),d=b.target.dataset.itemOrder;p.show=!1,a.items[c].tag=a.locTags[d],a.$digest()}})})}]),r.show=!1,r.$digest()}]),angular.module("myApp.directives",[]).directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]).directive("autoHeightTextarea",function(){return function(a,b){function c(a){var b=a.target.scrollHeight-a.target.offsetHeight;if(b>0){var c=$(a.target).height();$(a.target).height(c+b)}}b[0].addEventListener("input",c),b[0].addEventListener("click",c),b[0].addEventListener("blur",function(a){$(a.target).height(65)})}}).directive("autoCompletePlaces",["$http",function(){var a=document.createElement("style");return a.innerHTML=".auto-complete-places-container{position: absolute;display: none;}",document.getElementsByTagName("head")[0].appendChild(a),function(a,b){function c(){var a=d.getBoundingClientRect(),b=d.value;b&&h.getQueryPredictions({input:b},function(b){e.style.top=a.bottom+"px",e.style.left=a.left+"px",e.style.display="block",e.innerHTML="";for(var c=0,d=b.length;d>c;c++){var f=document.createElement("div");f.innerHTML=b[c].description,e.appendChild(f)}})}var d=b[0];d.placeholder="input a place";var e=document.createElement("div");e.className="auto-complete-places-container",document.body.appendChild(e);var f,g,h=new google.maps.places.AutocompleteService,i=300;d.addEventListener("input",function(){var a=d.value;return a?f?g=i:(g=i,f=setInterval(function(){g-=20,0>=g&&(clearInterval(f),f=null,c())},20),c(),void 0):e.style.display="none"},!1)}}]).directive("customSelect",["$compile",function(){return function(a,b,c){var d=a.$eval(c.options),e=document.createElement("ul");e.className="custom-select-list";var f=document.createElement("div");f.className="custom-select-selected",b[0].appendChild(f),b[0].appendChild(e),f.addEventListener("click",function(){$(b[0]).toggleClass("hover")}),d.forEach(function(b){var d=document.createElement("li");d.innerHTML=b.value,d.dataset.optionCode=b.code,e.appendChild(d),d.addEventListener("click",function(){a[c.selectModel]=b,a.$digest(),f.innerHTML=b.value})});var g=c.defaultSelect||0;f.innerHTML=d[g].value,a[c.selectModel]=d[g]}}]).directive("loadingAnimation",[function(){return function(){}}]).directive("clickToggleClass",[function(){return function(a,b,c){b[0].addEventListener("click",function(){$(b[0]).toggleClass(c.clickToggleClass)})}}]),angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]);