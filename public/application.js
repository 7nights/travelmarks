/* packaged at 2013-08-19 */
"use strict";angular.module("myApp",["myApp.filters","myApp.services","myApp.directives","myApp.controllers","HashManager","ngCookies"]).run(["HashManager","ModManager","User","$cookieStore",function(a,b,c,d){if(d.get("userinfo")){var e=d.get("userinfo");c.name=e.name,c.email=e.email,c._csrf=e._csrf,c.id=e.id,d.remove("userinfo"),c.$digest()}b.initMod="signIn",a.addListener("",function(){return c.name?(location.hash="home",void 0):(b.enter("signIn"),void 0)},-1).addListener("upload",function(){b.enter("upload")}).addListener("upload/:edit",function(){b.enter("upload")}).addListener("back",function(){a.slience(),history.back()}).addListener("home",function(){b.enter("home")}).addListener("home/:refresh",function(){b.enter("home")}).addListener("detail/:id",function(){b.enter("detail")}).addListener("explore",function(){b.enter("explore")}),b.addListener("start",function(a){return"upload"!==a&&"home"!==a||c.email?(document.getElementById("nav-btn-home").classList.remove("active"),document.getElementById("nav-btn-explore").classList.remove("active"),$(".nav .icon-white").removeClass("icon-white"),"home"===a?(document.getElementById("nav-btn-home").classList.add("active"),document.querySelector("#nav-btn-home i").classList.add("icon-white")):"explore"===a&&(document.getElementById("nav-btn-explore").classList.add("active"),document.querySelector("#nav-btn-explore i").classList.add("icon-white")),void 0):"#"}),a.other(function(){return c.username?(location.hash="home",void 0):(location.hash="",void 0)})}]),window.Utils={cookies:{get:function(a){if(document.cookie.length>0){var b=document.cookie.indexOf(a+"=");if(-1!==b){b+=a.length+1;var c=document.cookie.indexOf(";",b);return-1===c&&(c=document.cookie.length),unescape(document.cookie.substr(b,c))}}return null},set:function(a,b,c){document.cookie=a+"="+escape(b)+(c?";expires="+new Date(Date.now()+c).toUTCString():"")},remove:function(a){this.set(a,"",-3600)}},syncQueue:function(){function a(){this._queue=[],this._index=0}return a.prototype={push:function(a){return this._queue.push(a),this},exec:function(a){var b=function(a,c){if(console.log("next called",a,c),b.index++,!(b.index>=b.queue.length)){if(a){for(;b.index<b.queue.length;){if(b.queue[b.index]&&3===b.queue[b.index].length)return b.queue[b.index](a,c,b);b.index++}throw a}var d=b.queue[b.index].length;2===d?b.queue[b.index](c,b):3===d&&b.queue[b.index](null,c,b)}};b.index=-1,b.queue=this._queue,b(null,a)}},a}()},angular.module("HashManager",[]).provider("HashManager",function(){console.log("load HashManager");var a=[],b=null,c={},d=!1;this.addListener=function(b,c,d){void 0===d&&(d=0);for(var e=/:([^\/]*)/g,f=e.exec(b),g=[];null!==f;)g.push(f[1]),f=e.exec(b);for(var h=b.replace(e,"([^/]*)"),i={urlReg:"^"+h+"$",args:g,"function":c,priority:d},j=!1,k=0,l=a.length;l>k;k++)a[k].priority<d&&(a.splice(k,0,i),j=!0);return j||a.push(i),this},this.other=function(a){b=a},this.slience=function(){d=!0},this.$get=function(){var a=this;return{addListener:function(b,c,d){return a.addListener(b,c,d),this},getArgs:function(){return c},other:a.other,slience:function(){d=!0}}};var e=function(){if(d)return d=!1;for(var e=0,f=a.length;f>e;e++){var g=new RegExp(a[e].urlReg),h=window.location.hash;"#"===h[0]&&(h=h.substr(1));var i=h.match(g);if(null!==i){for(var j={},k=1;k<=a[e].args.length;k++)j[a[e].args[k-1]]=i[k];return c=j,a[e]["function"](j),void 0}}null!==b&&(c=[],b())};window.addEventListener("hashchange",e),window.addEventListener("load",e)}),angular.module("myApp.services",["ng","HashManager"]).value("version","0.1").provider("User",function(){var a;angular.injector(["ng"]).invoke(["$rootScope",function(b){a=b.$new(),a.eatCookie=function(){var b=Utils.cookies,c=JSON.parse(b.get("userinfo"));return c?(a.name=c.name,a.email=c.email,a._csrf=c._csrf,a.id=c.id,b.remove("userinfo"),a.$digest(),!0):!1},a.eatCookie.$inject=["cookie"]}]),this.$get=function(){return a}}).provider("Util",function(){var a=function(){var a,b,c,d=angular.element("<div ng-show='visible' class='alert notice'><button type='button' class='close' ng-click='close()'>×</button><span>{{msg}}</span></div>"),e=angular.element("<div ng-show='visible' class='tooltip bottom fade in'><div class='tooltip-arrow'></div><div class='tooltip-inner'>{{tooltip}}</div></div>");angular.injector(["ng"]).invoke(["$rootScope","$compile",function(d,e){a=d.$new(),b=d.$new(),c=e}]),a.close=function(){a.visible=!1},a.visible=!1,b.visible=!1;var f=c(d)(a,function(a){document.body.appendChild(a[0])}),g=c(e)(b,function(a){document.body.appendChild(a[0])}),h=function(a){a.timer||(a.timer=setInterval(function(){a.ttl=a.ttl-100,a.ttl<=0&&(clearInterval(a.timer),a.ttl=0,a.timer=null,a.visible=!1,a.$digest())},100))};return function(c,d,e){if(e){b.ttl=d||5e3,h(b),b.tooltip=c,b.visible=!0,b.$digest();var i=$(e).offset(),j={height:e.offsetHeight};g[0].style.position="absolute",g[0].style.left=i.left+"px",g[0].style.top=i.top+j.height+"px"}else a.ttl=d||5e3,h(a),a.msg=c,a.visible=!0,a.$digest(),f[0].style.left=(window.innerWidth-f[0].offsetWidth)/2+"px"}}(),b=function(a,b){function c(a){a||(a=new Date);var b,c=a,d=c.getFullYear(),e=c.getMonth(),g=(c.getDay(),c.getDate()),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],i=[31,0===d%4?29:0===d%100&&0===d%400?29:28,31,30,31,30,31,31,30,31,30,31],j=new Date(d,e,1).getDay(),k=j,l=document.createElement("tr"),m="cal-today",n="cal-title",o="cal-first-line";f.className=n,f.innerHTML=f.innerHTML='<span class="cal-btn"><i data-pre="true" class="icon-chevron-left icon-white"></i></span><span class="cal-title-text">'+a.getFullYear()+", "+(a.getMonth()+1)+'</span><span class="cal-btn"><i data-next="true" class="icon-chevron-right icon-white"></i></span>',b=document.createElement("table"),l.className="cal-firstTr";for(var p=0;7>p;p++)l.innerHTML+="<th class='"+o+"'>"+h[p]+"</th>";b.appendChild(l),l=document.createElement("tr");for(var p=0;k>p;p++)l.innerHTML+="<td></td>";for(var p=1,q=i[e];q>=p;p++)l.innerHTML+=p===g&&a.getMonth()===(new Date).getMonth()?"<td class='"+m+"'>"+p+"</td>":"<td>"+p+"</td>",6!==k?k++:(k=0,b.appendChild(l),l=document.createElement("tr"));if(0!==k)for(var p=k;6>=p;p++)l.innerHTML+="<td></td>";return b.appendChild(l),b}function d(c){c.addEventListener("click",function(c){var d=c.target;"TD"===d.tagName&&""!==d.innerHTML&&b(new Date(a.setDate(+d.innerHTML)))},!1)}var e=document.createElement("div"),f=document.createElement("div");a||(a=new Date),f.addEventListener("click",function(b){var g=b.target;if("I"===g.tagName||"cal-btn"===g.className){"cal-btn"===g.className&&(g=g.childNodes[0]),"true"==g.dataset.pre?a.setMonth(a.getMonth()-1):a.setMonth(a.getMonth()+1);var h=e.getElementsByTagName("TABLE")[0];h.parentElement.removeChild(h),h=c(a),d(h),e.appendChild(h),f.getElementsByClassName("cal-title-text")[0].innerHTML=a.getFullYear()+", "+(a.getMonth()+1)}},!1);var g=c(a);return d(g),e.appendChild(f),e.appendChild(g),e},c={notice:a,getDatePicker:b};this.$get=function(){return c}}).provider("Item",function(){this.$get=function(){return{empty:function(){return[this.one()]},one:function(){return{pictures:[],post:""}},picture:function(a,b){return{src:a,progress:0,file:b}}}}}).provider("ModManager",["HashManagerProvider",function(){var a=null,b=function(a,b,c,d){document.getElementById("mod-"+a),document.getElementById("mod-"+b),$("#mod-"+a).css({"-webkit-transform":"translateX(-50px)",opacity:0}),setTimeout(function(){$("#mod-"+a).css({display:"none","-webkit-transform":"translateX(0px)",opacity:1}),$("#mod-"+b).css({display:"block",opacity:0,"-webkit-transform":"translateX(50px)"}),setTimeout(function(){$("#mod-"+b).css({"-webkit-transform":"translateX(0px)",opacity:1})},0),c(),setTimeout(function(){d()},300)},300)},c=!1,d=!1,e=[],f=[],g=[],h=[],i=function(a){switch(a){case"before":return e;case"after":return f;case"unload":return g;case"start":return h}return null},j=function(a,b){for(var c=i(a),d=!1,e=c.length;e--;)if(d=c[e](b),"start"===a&&d)return d},k=function(e,f){if(c!==!1)return d=e,void 0;c=!0;var g=j("start",e);return g?(location.hash=g,c=!1,d&&k(d),void 0):(null===a&&(a=l.initMod),"function"!=typeof f&&(f=b),j("before",e),l.firstLoad?(l.firstLoad=!1,a=e,j("after",e),c=!1,d&&(k(d),d=!1),document.getElementById("mod-"+l.initMod).style.display="none",document.getElementById("mod-"+e).style.display="block",void 0):(f(a,e,function(){j("unload",a)},function(){j("after",e),document.body.style.overflow="auto",a=e,c=!1,d&&(k(d),d=!1)}),void 0))},l=this;this.initMod=null,this.firstLoad=!0,this.enter=k,this.data=null,this.$get=function(){return{enter:k,addListener:function(a,b){var c=i(a);c.push(b)},removeListener:function(a,b){for(var c=i(a),d=c.length;d--;)if(c[d]===b)return c.splice(d,1),!0;return!1},get currentMod(){return a},set initMod(a){l.initMod=a},setData:function(a){l.data=a},getData:function(){return l.data}}}}]),angular.module("myApp.controllers",[]).controller("SignInCtrl",["$scope","$http","ModManager","Util","User",function(a,b,c,d,e){a.loginBoxDesc="Sign up right now!",a.loginBtn="Sign In",a.showEmail=!1,a.errorMessage="";var f=!1;a.signUp=function(b){if(!a.submiting){if(f=!f){a.loginBtn="Sign Up",a.loginBoxDesc="Already have an account.",a.showEmail=!0;var c=$("#login-email").height();$("#login-email, #login-repassword").css({height:0,opacity:0}),$("#login-email, #login-repassword").animate({height:c,opacity:1},200)}else a.loginBtn="Sign In",a.loginBoxDesc="Sign up right now!",a.showEmail=!1;!!b&&b.preventDefault()}},a.submit=function(){if(!a.submiting){var c=/^[^_]([a-zA-Z0-9\u4e00-\u9fa5]+_?)+[^_]$/;if(f&&!c.test(a.inputUsername))return d.notice("用户名非法",1e7),alert("用户名非法");if(!a.inputUsername||!a.inputPassword)return a.errorMessage="表格要完整才可以呈上~";if(f&&!a.inputEmail)return a.errorMessage="表格要完整才可以呈上~";if(a.inputUsername<5)return a.errorMessage="用户名必须大于5个字符";if(f&&a.inputPassword!==a.inputRepassword)return a.errorMessage="两次输入的密码不相同";if(!document.getElementById("login-email").validity.valid)return a.errorMessage="请输入正确的电子邮箱";a.submiting=!0,$("#login-btn").css("opacity",".3"),f?b({method:"POST",url:"/signup",data:{name:a.inputUsername,email:a.inputEmail,passwd:hex_md5(a.inputPassword),repasswd:hex_md5(a.inputRepassword)}}).success(function(b){a.submiting=!1,1===b.status?(a.errorMessage="创建成功~",a.inputPassword="",a.signUp()):(window.location.hash="",a.errorMessage=b.message)}).error(function(){a.submiting=!1}):b({method:"POST",url:"/signin",data:{name:a.inputUsername,passwd:hex_md5(a.inputPassword)}}).success(function(b){a.submiting=!1,$("#login-btn").css("opacity","1"),1===b.status?e.eatCookie()&&(window.location.hash="home"):(window.location.hash="",a.errorMessage=b.message)}).error(function(){a.submiting=!1,$("#login-btn").css("opacity","1"),window.location.hash=""})}}}]).controller("ExploreCtrl",["$scope","$http","User","ModManager",function(a,b,c,d){function e(){return $(".explore-container").masonry({itemSelector:".explore-mark",columnWidth:442,gutter:10})}a.marks=[];var f;d.addListener("before",function(c){"explore"===c&&(f||(g&&(h=!h,g.masonry("destroy"),g=null,document.querySelector(".explore-container").classList.remove("tworows")),b.get("/mark/explore?type=latest").success(function(b){return-1===b.status?alert("TODO: Error!"):(a.marks=b,f=!0,void 0)}).error(function(){})))});var g,h=0;a.switchMode=function(){h=!h,h?(g=e(),document.querySelector(".explore-container").classList.add("tworows"),setTimeout(function(){g=e()},0)):g&&(g.masonry("destroy"),g=null,document.querySelector(".explore-container").classList.remove("tworows"))},a.getAvatar=function(a){return"http://www.gravatar.com/avatar/"+a+"?s=24&d=mm"},a.goDetail=function(b){for(;"LI"!==b.target.tagName;)b.target=b.target.parentElement;var c=b.target.dataset.itemNo;location.hash="#detail/"+a.marks[c]._id}}]).controller("NavCtrl",["$scope","$http","User",function(a,b,c){function d(){c.email&&(a.avatar="http://www.gravatar.com/avatar/"+hex_md5(c.email)+"?s=32&"+"d=mm",a.email=c.email,a.signout="signout?_csrf="+c._csrf)}c.$watch("name",function(a){a&&d()}),setTimeout(d,0)}]).controller("HomeCtrl",["$scope","$http","ModManager","User","HashManager",function(a,b,c,d,e){function f(){b({method:"GET",url:"/mark/get"}).success(function(b){a.marks=b.marks,a.totalMarks=b.totalMarks,a.totalPictures=b.totalPictures})}c.addListener("before",function(a){if("home"===a){if(!d.email)return;(!g||e.getArgs().refresh)&&(g=!0,f())}});var g=!1;a.totalMarks=0,a.totalPictures=0,a.marks=[],a.filterDate=function(a){return new Date(a).toLocaleString()},document.getElementById("signIn-cover").src="img/samples/"+Math.round(6*Math.random()+1)+".jpg",a.modeSwitch=function(a){switch($(".mark").css({"margin-top":10,"border-bottom-width":"3px"}),$(".marks-container").removeClass("list"),a){case"middle":$(".mark").animate({height:"200px"});break;case"small":$(".mark").animate({height:"100px"});break;case"large":$(".mark").animate({height:"400px"});break;case"list":$(".mark").animate({height:"40px"}),$(".marks-container").addClass("list"),$(".mark").css({"margin-top":0,"margin-bottom":0,"border-bottom-width":0})}},a.goTo=function(a){location.hash="detail/"+a}}]).controller("DetailCtrl",["$scope","$http","HashManager","ModManager","User",function(a,b,c,d,e){var f;d.addListener("before",function(d){h=!1,g&&(g.masonry("destroy"),g=null);var j={one:function(){return{pictures:[],post:""}},empty:function(){return[this.one()]},picture:function(a){return{src:a,loaded:!1}}};"detail"===d&&(c.getArgs().id!==i&&(a.title="",a.location="",a.read=0,a.author="",a.summary="",a.total=0,a.date="",a.items=[],i=c.getArgs().id,setTimeout(function(){document.body.scrollTop=0},300)),b({method:"GET",url:"mark/getMark",params:{id:c.getArgs().id}}).success(function(b){-1!==b.status&&(f=b,a.id=c.getArgs().id,a.title=b.title,a.location=b.location,a.read=b.read,a.author=b.author,a.summary=b.summary,a.total=b.total,a.date=b.date,a.editable=a.author===e.name?!0:!1,a.items=[],b.items.forEach(function(b){var c=j.one();c.post=b.post,c.title=b.title,c.date=b.date,c.tag=b.tag,b.pictures.forEach(function(b){var d=j.picture(b),e=new Image;if(e.complete){d.loaded=!0;try{a.$digest()}catch(f){}}else e.onload=function(){d.loaded=!0;try{a.$digest()}catch(b){}};e.src=b,c.pictures.push(d)}),a.items.push(c)}))}))}),a.edit=function(){return alert("编辑功能有待working……")},a.remove=function(){var c=prompt("Do you really want to delete this mark? Enter DELETE to continue.");if("DELETE"===c){var d=a.id;b({method:"post",url:"/mark/delete",data:{markId:d,_csrf:e._csrf}}).success(function(a){return 1===a.status?location.hash="home/refresh":void 0}).error(function(){})}},a.wordWrap=function(a){return a},a.dateFilter=function(a,b){var a=new Date(a);switch(b){case 0:return a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate();case 1:return a.getMonth()+1+"."+a.getDate()}};var g,h=!1;a.getMode=function(){return h?"tworows":""},a.switchMode=function(){return(h=!h)?(g=$(".item-box li").masonry({itemSelector:".it-pic-container, .it-post, .item-date",columnWidth:435}),setTimeout(function(){g=$(".item-box li").masonry({itemSelector:".it-pic-container, .it-post, .item-date",columnWidth:435,gutter:5})},20),void 0):(g&&(g.masonry("destroy"),g=null),void 0)};var i=null;a.title="",a.location="",a.read=32,a.author="",a.summary="",a.total=0,a.date="",a.ifLoad=function(b,c){return a.items[b].pictures[c].loaded?"loaded":""}}]).controller("UploadCtrl",["$scope","$http","ModManager","Item","$q","Util","HashManager",function(a,b,c,d,e,f,g){function h(a){for(;null!==a;){if(void 0!==a.dataset.itemNo)return a.dataset.itemNo;a=a.parentElement}return-1}var i,j=new google.maps.places.PlacesService(document.createElement("div"));c.addListener("before",function(b){if("upload"===b&&(a.editMode=!1,a.title="",a.summary="",a.locTags=[],a.items=d.empty()),"edit"===g.getArgs().edit){a.editMode=!0;var e=c.getData();if(!e)return history.back();i=e,c.setData(null),a.title=e.title,a.author=e.author,a.summary=e.summary,a.locTags=[];var f=[];e.items.forEach(function(b){var c=b.tag;if(!(c._id in f)){f[c._id]=!0,b.addr=c.addr||"loading...",b.pos=b.addr,a.locTags.push({name:c.name,geometry:{lat:c.lat,lng:c.lng},pos:c.addr||"loading...",results:[{formatted_address:c.addr||c.name,geometry:{location:{lat:function(){return this.geometry.lat},lng:function(){return this.geometry.lng}}}}],activeTag:0});var d=a.locTags.length-1;b.addr?a.locTags[d].pos=b.addr:j.nearbySearch({location:new google.maps.LatLng(c.lat,c.lng),radius:5},function(b){a.locTags[d].pos=b[0].vicinity})}}),a.items=e.items,a.$digest()}a.$digest()}),c.addListener("after",function(a){"upload"===a&&setTimeout(function b(){var a=document.getElementById("upload-title-input");a.focus(),document.activeElement!==a&&setTimeout(b,100)},100)});var k,l,m,n,o=!0;angular.injector(["ng"]).invoke(["$rootScope","$compile",function(b,c){m=b.$new(),k=a.$new(),m.deleteTag=function(){var b=a.locTags[m.order].uid;$("#mod-upload .item-box li").each(function(c){a.items[c].tag&&a.items[c].tag.uid===b&&(a.items[c].tag=null)}),a.locTags.splice(m.order,1),a.$digest(),m.show=!1};var d=angular.element('<div ng-show="show" class="upload-location-selector"><div class="selector-nav"><span class="selector-result"><i class="icon-white icon-map-marker"></i><span ng-bind-template="{{result}}" class="result-text"></span></span></div><div class="input-wrap"><input ng-model="inputName" type="text" class="selector-input-name" /></div><div class="input-wrap"><input type="text" class="selector-input-pos" ng-model="inputPos" /></div><div class="selector-results"><div class="results-item" ng-repeat="it in results" data-item-order="{{$index}}" ng-bind-template="{{it.formatted_address}}"></div><div class="results-footer" ><div ng-click="deleteTag()" class="delete">Delete this tag</div><div class="results-num" ng-bind-template="{{results.length}} result(s)"></div><div class="clear"></div></div></div></div>');n=c(d)(m,function(b){document.body.appendChild(b[0]);var c=document.getElementsByClassName("selector-results")[0];c.addEventListener("click",function(b){if(b.target.classList.contains("results-item")){var c=+b.target.dataset.itemOrder;a.locTags[m.order].pos=m.results[c].formatted_address,a.locTags[m.order].results=m.results,a.locTags[m.order].activeTag=c,m.show=!1,a.$digest(),m.$digest(),b.stopPropagation()}});var d,e,f=document.createElement("div"),g=new google.maps.places.PlacesService(f),h=300;m.$watch("inputName",function(b){a.locTags&&(a.locTags[m.order].name=b,a.$digest())}),m.$watch("inputPos",function(a,b){function c(){m.inputPos&&g.textSearch({query:m.inputPos},function(a){m.results=a;try{m.$digest()}catch(b){}})}if(void 0!==b){if(o)return o=!1;if(a){if(d)return e=h;e=h,d=setInterval(function(){e-=20,0>=e&&(clearInterval(d),d=null,c())},20),c()}}})}),k.show=!1,d=angular.element("<div ng-show='show' class='tag-selector'><div ng-repeat='tag in locTags' class='tag' data-item-order='{{$index}}' ng-bind-template='{{tag.name}}'></div></div>"),l=c(d)(k,function(b){document.body.appendChild(b[0]),$(b[0]).delegate(".tag","click",function(b){if(console.log(this),this.classList.contains("tag")){var c=h(k.currentTarget),d=b.target.dataset.itemOrder;k.show=!1,a.items[c].tag=a.locTags[d],a.$digest()}})})}]),m.show=!1,m.$digest(),a.locTags=[],$("#upload-location-input").bind("keydown",function(b){if(13===b.keyCode){if(""===$.trim(b.target.value))return;a.locTags.push({name:b.target.value,pos:"loading...",uid:parseInt(1e4*Math.random())+parseInt(1e4*Math.random())}),a.$digest();var c=a.locTags.length-1,d=b.target.value,e=new google.maps.places.PlacesService(document.createElement("div"));b.target.value="",e.textSearch({query:d},function(b){if(0===b.length)return a.locTags.splice(c,1),alert("not found");a.locTags[c].results=b,a.locTags[c].activeTag=0,a.locTags[c].pos=b[0].formatted_address;for(var d=$("#mod-upload .item-box li"),e=d.length;e--;)a.items[e].tag||(a.items[e].tag=a.locTags[a.locTags.length-1]);a.$digest()})}});var p;$("#mod-upload .item-box").delegate(".item-tag","click",function(a){if(p===a.target&&k.show)return k.show=!1,k.$digest();p=a.target,k.currentTarget=a.target,k.show=!0;var b=$(a.target).offset();b.bottom=b.top+a.target.offsetHeight,b.right=b.left+a.target.offsetWidth,k.$digest(),l[0].style.top=b.bottom+"px",l[0].style.left=b.right-l[0].offsetWidth+"px"}),$(".location-tags-container").delegate(".location-tag","click",function(b){for(o=!0;!("itemOrder"in b.target.dataset);)b.target=b.target.parentNode;var c=b.target;document.getElementsByClassName("upload-location-selector")[0];var d=+c.dataset.itemOrder;m.show=!0,m.result=a.locTags[d].name+" - "+a.locTags[d].pos,m.inputName=a.locTags[d].name,m.inputPos=a.locTags[d].pos,m.results=a.locTags[d].results,m.order=d,m.$digest();var e=$(c).offset();n[0].style.top=e.top-9+"px",n[0].style.left=e.left-22+"px",b.stopPropagation(),$(document).one("click",function f(a){if(m.show){for(var b=a.target;b&&b.classList;){if(b.classList.contains("upload-location-selector"))return m.show&&$(document).one("click",f),void 0;b=b.parentNode}m.show=!1,m.$digest()}})}),$("#mod-upload .item").delegate("input, textarea","focus",function(a){a.target.parentElement.classList.add("focus")}),$("#mod-upload .item").delegate("input, textarea","blur",function(a){a.target.parentElement.classList.remove("focus")}),$("#mod-upload .item").click(function(a){$(a.target).hasClass("item")||(a.target=a.target.parentElement);var b=a.target.getElementsByTagName("input")[0]||a.target.getElementsByTagName("textarea")[0]||a.target.parentNode.parentNode.getElementsByTagName("input")[0];b.focus()});var q;$(".item-box").delegate(".it-post-date","focus",function(b){var c=b.target;c.blur(),q||(q=f.getDatePicker(null,function(b){q.parentElement.removeChild(q),q=null,c.dataset.date=b.getTime(),c.value=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate(),a.items[h(c)].date=c.value,a.$digest()}),q.className="date-picker",document.body.appendChild(q))});var r=!1;document.addEventListener("dragenter",function(a){return r||"Files"!==a.dataTransfer.types[0]||(r=!0,document.body.classList.add("dragenter")),a.preventDefault(),!1},!1),document.addEventListener("dragover",function(a){return r||"Files"!==a.dataTransfer.types[0]?a.dataTransfer.files.length>0&&(a.dataTransfer.effectAllowed="none",a.dataTransfer.dropEffect="none",a.preventDefault()):(r=!0,document.body.classList.add("dragenter")),(a.target.classList.contains("upload-pictures")||a.target.classList.contains("drop-pictures")||a.target.parentElement&&a.target.parentElement.classList.contains("drop-pictures"))&&"Files"===a.dataTransfer.types[0]?(a.dataTransfer.effectAllowed="all",a.dataTransfer.dropEffect="copy",a.preventDefault()):void 0},!1),document.addEventListener("dragleave",function(a){return 0===a.x&&0===a.y?(document.body.classList.remove("dragenter"),r=!1,a.preventDefault(),!1):void 0},!1),a.items=d.empty(),a.addMore=function(){a.items.push(d.one()),a.items[a.items.length-1].tag=a.locTags[a.locTags.length-1]},$(document).delegate(".upload-pictures","drop",function(b){for(var c=b.originalEvent.dataTransfer.files,e=0,f=c.length;f>e;e++)if(-1!==c[e].type.indexOf("image")){b.preventDefault();var g=new Worker("js/worker-file-reader.js");g._file=c[e],g.addEventListener("message",function(c){function e(){return g.drawImage(0,0,i),postMessage(f.toDataURL())}var f=document.createElement("canvas"),g=f.getContext("2d"),i=new Image;i.src=fr.result,i.complete?e():i.onload=e,f.width=220,f.height=140,a.items[h(b.target)].pictures.push(d.picture(c.data,this._file)),a.$digest()}),g.postMessage({file:c[e],method:"readAsDataURL"})}document.body.classList.remove("dragenter"),r=!1,b.preventDefault()}),a.progressWidth=function(a){return $(document.getElementsByClassName("upload-pictures")[0]).hasClass("uploading")?216*(a.progress/100)+"px":"220px"},a.getModTitle=function(){return a.editMode?"Editing Mark":"Create a Mark!"},a.uploading=!1,a.ifUploading=function(){return a.uploading?"disable-buttons":""},a.demoUploadFinished=0,a.save=function(){function c(a){i.push(function(c,d){console.log(a);var e={markId:h,name:a.name,addr:a.pos,lat:a.results[a.activeTag].geometry.location.lat(),lng:a.results[a.activeTag].geometry.location.lng()};b({method:"post",url:"tag/create",data:e}).success(function(b){1===b.status&&(a.tagId=b.data.tagId,d(null,a.tagId))}).error(function(){d(new Error("Upload failed"))})})}function e(c){var d;i.push(function(e,f){var g=a.items[c].tag;b({method:"POST",url:"item/create",data:{markId:h,date:new Date(a.items[c].date).getTime(),post:a.items[c].post,title:a.items[c].title,tag:g.tagId}}).success(function(a){1===a.status&&(d=a.data.itemId,f(null,a.data.itemId))}).error(function(){f(new Error("Upload failed."))})}),a.items[c].pictures.forEach(function(b,c){f(d,b,c),a.demoUploadFinished++})}function f(b,c){i.push(function(b,d){console.log("upload picture");var e=b,f=new FormData;f.append("image",c.file),f.append("itemId",e);var g=new XMLHttpRequest;g.open("POST","/picture/save"),g.onload=function(){var a=JSON.parse(g.response);-1===a.status&&d(a),console.log(d),d(null,"heihei")},g.send(f);var h=parseInt(10+10*Math.random());setTimeout(function i(){c.progress++,a.$digest(),c.progress<100?setTimeout(i,h):a.demoUploadFinished--},h)})}if(!a.uploading){if(a.uploading=!0,a.editMode)return a.$digest();$(".upload-pictures").addClass("uploading");var g=!0;if(a.items.forEach(function(a){a.tag||(alert("You need to select a location tag for each site."),g=!1)}),!g)return a.uploading=!1,void 0;var h,i=new Utils.syncQueue;i.push(function(c,d){b({method:"POST",url:"mark/create",data:JSON.stringify({title:a.title,summary:a.summary})}).success(function(b){return-1===b.status?(a.uploading=!1,d(b)):(h=b.data.markId,d(null,b.data.markId),void 0)}).error(function(){alert("Upload failed. Please try again later.")})}),a.locTags.forEach(function(a){c(a)}),a.items.forEach(function(a,b){(a.post||0!==a.pictures.length)&&e(b)}),i.push(function(b,c){if(a.demoUploadFinished>0)return setTimeout(tempz,200);a.uploading=!1,$(".upload-pictures").removeClass("uploading"),a.items=d.empty(),a.title="",a.summary="",a.location="";try{a.$digest()}catch(e){}location.hash="detail/"+h}).push(function(a,b,c){return a?("object"==typeof a&&"status"in a&&alert(a.message),void 0):c(null,b)}).exec();try{a.$digest()}catch(j){}}};var s=0;a.upload=function(a){s=h(a.target),angular.element(".upload-input")[0].click()},angular.element(".upload-input")[0].addEventListener("change",function(b){var c=new FileReader;c.onload=function(){a.items[s].pictures.push(d.picture(this.result,b.target.files[0])),a.$digest()},c.readAsDataURL(b.target.files[0])},!1)}]),angular.module("myApp.directives",[]).directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]).directive("autoHeightTextarea",function(){return function(a,b){b[0].addEventListener("input",function(a){if(a.target.scrollHeight>a.target.offsetHeight){var b=$(a.target).height();$(a.target).height(b+100)}})}}).directive("autoCompletePlaces",["$http",function(){var a=document.createElement("style");return a.innerHTML=".auto-complete-places-container{position: absolute;display: none;}",document.getElementsByTagName("head")[0].appendChild(a),function(a,b){function c(){var a=d.getBoundingClientRect(),b=d.value;b&&h.getQueryPredictions({input:b},function(b){e.style.top=a.bottom+"px",e.style.left=a.left+"px",e.style.display="block",e.innerHTML="";for(var c=0,d=b.length;d>c;c++){var f=document.createElement("div");f.innerHTML=b[c].description,e.appendChild(f)}})}var d=b[0];d.placeholder="input a place";var e=document.createElement("div");e.className="auto-complete-places-container",document.body.appendChild(e);var f,g,h=new google.maps.places.AutocompleteService,i=300;d.addEventListener("input",function(){var a=d.value;return a?f?g=i:(g=i,f=setInterval(function(){g-=20,0>=g&&(clearInterval(f),f=null,c())},20),c(),void 0):e.style.display="none"},!1)}}]),angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]);